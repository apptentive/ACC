<!DOCTYPE html>
<html ng-app="accApp">
<head>
  <title>Projects list</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.4/angular-animate.js"></script>
  <script>
    var accApp = angular.module('accApp', []);
    accApp.controller('ProjectCtrl', ['$scope', '$http', function ($scope, $http) {
        $scope.projectList = []
        $scope.getProjects = function() {
          $http({
            method: 'GET',
            url: '/projects'
          })
          .success(function(response) { $scope.projectList = response })
          .error(function() { console.log("error") });
        }
        // Project methods
        $scope.openProject = function(id) {
          $scope.project = []
          $http({
            method: 'GET',
            url: '/projects/' + id
          })
          .success(function(response) { $scope.project = response })
          .error(function() { console.log("error") })
        }
        $scope.addProject = function() {
          $http({
            method: 'POST',
            url: '/projects',
            data: this.newProject
          })
          .success(function() { console.log() })
          .error(function() { console.log("error") })
        }
        $scope.deleteProject = function(id) {
          $http({
            method: 'DELETE',
            url: '/projects/' + id
          })
          .success(function(project) { console.log(project) })
          .error(function() { console.log("error") })
        }
        // Attribute methods
        $scope.attributesList = []
        $scope.getAttributes = function(id) {
          $http({
            method: 'GET',
            url: '/projects/' + id + '/attributes'
          })
          .success(function(response) { $scope.attributesList = response })
          .error(function() { console.log("error") })
        }
        $scope.addAttribute = function(id) {
          $http({
            method: 'POST',
            url: '/projects/' + id + '/attributes',
            data: this.newAttribute
          })
          .success(function() { console.log("Added attribute") })
          .error(function() { console.log("error") })
        }
        $scope.deleteAttribute = function(id) {
          $http({
            method: 'DELETE',
            url: '/attributes/' + id
          })
          .success(function() { console.log("Attribute deleted") })
          .error(function() { console.log("error") })
        }
        // Component methods
        $scope.componentsList = []
        $scope.getComponents = function(id) {
          $http({
            method: 'GET',
            url: '/projects/' + id + '/components'
          })
          .success(function(response) { $scope.componentsList = response })
          .error(function() { console.log("error") })
        }
        $scope.addComponent = function(id) {
          $http({
            method: 'POST',
            url: '/projects/' + id + '/components',
            data: this.newComponent
          })
          .success(function() { console.log("added component!") })
          .error(function() { console.log("error") })
        }
        $scope.deleteComponent = function(id) {
          $http({
            method: 'DELETE',
            url: '/components/' + id
          })
          .success(function() { console.log("Component deleted") })
          .error(function() { console.log("error") })
        }
        // Capability methods
        $scope.capabilitiesList = []
        $scope.getCapabilities = function(id) {
          $http({
            method: 'GET',
            url: '/projects/' + id + '/capabilities'
          })
          .success(function(response) { $scope.capabilitiesList = response })
          .error(function() { console.log("error returning capabilities") })
        }
        $scope.getCapability = function(id, attribute_id, component_id) {
          $http({
            method: 'GET',
            url: '/projects/' + id + '/capability/' + attribute_id + '/' + component_id
          })
        }
        // $scope.addCapability = function(id) {
        //   $http({
        //     method: 'POST',
        //     url: '/projects/' + id + '/capabilities',
        //     data: { name: this.capabilityName, attribute_id: this.capabilityAttr this.capabilityComp, project_id: id }
        //   })
        // }
        $scope.deleteCapability = function(id) {
          $http({
            method: 'DELETE',
            url: '/capabilities/' + id
          })
          .success(function() { console.log("Capability deleted") })
          .error(function() { console.log("error deleting capability") })
        }

        // Fill table
        $scope.fillTable = function(r, c) {
          var comp_id = $scope.componentsList[r-1].id;
          var attr_id = $scope.attributesList[c-1].id;
          var tmp;
          console.log("compList = " + $scope.componentsList)
          console.log("comp_id = " + comp_id)
          console.log("attr_id = " + attr_id)
          function getById(id, myArray) {
            myArray.filter(function(obj) {
              if(obj.id == id) {
                tmp = myArray.indexOf(obj)
                console.log("tmp=" + tmp)
              }
            })
            return tmp
          };
          comp = getById(comp_id, $scope.capabilitiesList);
          attr = getById(attr_id, $scope.capabilitiesList);
          console.log("comp = " + comp);
          console.log("attr = " + attr);
          // c_index = $scope.capabilitiesList.where(["attribute_id"] == attr_id).to_i
          // a_index = $scope.capabilitiesList.where(["component_id"] == comp_id).to_i
          // a_index = $scope.capabilitiesList.index { |cap| cap["attribute_id"] == attr_id }
          if (comp == attr) {
            document.getElementById("grid").rows[r].cells[c].innerHTML = $scope.capabilitiesList[comp].name
          }
          else {
            document.getElementById("grid").rows[r].cells[c].innerHTML = "No Capability"
          }
        }
      }
    ]);

  </script>
</head>
<body ng-controller="ProjectCtrl">
  <div class="sidebar" ng-init="getProjects()">
    <h2>Project list</h2>
    <table class="list">
      <tr ng-repeat="project in projectList">
        <th><a href="" ng-click="openProject(project.id); getAttributes(project.id); getComponents(project.id); getCapabilities(project.id)">{{project.name}} </a></th>
        <td><a href="" ng-click="deleteProject(project.id)">Delete</a></td>
      </tr>
      <th colspan="2"><a href="" ng-click="showform=true" ng-hide="showform">Add</a></th>
      <tr ng-show="showform">
        <form class="new_project" ng-submit="addProject()">
          <td colspan="2">
            New project name: <input ng-model="newProject" type="text"><br>
            <input type="submit" value="Create Project" ng-show="showform" ng-click="showform=false"><br>
            <a href="" ng-click="showform=false" ng-show="showform">Cancel</a>
          </td>
        </form>
      </tr>
    </table>
  </div>
  <div class="project" ng-init="openProject(1); getAttributes(1); getComponents(1); getCapabilities(1)">
    <h1>{{project.name}}</h1>
    <table id="grid">
      <tr>
        <th>&nbsp</th>
        <th ng-repeat="attribute in attributesList">{{attribute.name}}</th>
      </tr>
      <tr ng-repeat="component in componentsList">
        <th>{{component.name}}</th>
        <th ng-repeat="attribute in attributesList"></th>
      </tr>
    </table>
    <h4><a href="" ng-click="edit_table=true" ng-hide="edit_table">Edit Table</a></h4>
    <div class="attr_comp_list" ng-show="edit_table" col="2">
      <table id="edit_attributes">
        <tr>
          <th><h3>Attributes:</h3></th>
        </tr>
        <tr ng-repeat="attribute in attributesList">
          <td>{{attribute.name}}</td>
          <td><a href="" ng-click="deleteAttribute(attribute.id)">Remove</a></td>
        </tr>
        <th colspan="2"><a href="" ng-click="addAttr=true" ng-hide="addAttr">Add</a></th>
        <tr ng-show="addAttr">
          <form ng-submit="addAttribute(project.id)">
            <td colspan="2">
              New Attribute Name:<br>
              <input ng-model="newAttribute" type="text"><br>
              <input type="submit" value="Add Attribute" ng-click="addAttr=true"><br>
              <a href="" ng-click="addAttr=false">Cancel</a>
          </form>
        </tr>
      </table>
      <table id="edit_components">
        <tr>
          <th><h3>Components:</h3></th>
        </tr>
        <tr ng-repeat="component in componentsList">
          <td>{{component.name}}</td>
          <td><a href="" ng-click="deleteComponent(component)">Remove</a></td>
        </tr>
        <th colspan="2"><a href="" ng-click="addComp=true" ng-hide="addComp">Add</a></th>
        <tr ng-show="addComp">
          <form ng-submit="addComponent(project.id)">
            <td colspan="2">
              New Component Name:<br>
              <input ng-model="newComponent" type="text"><br>
              <input type="submit" value="Add Component" ng-click="addComp=true"><br>
              <a href="" ng-click="addComp=false">Cancel</a>
          </form>
        </tr>
      </table><br>
      <button ng-click="edit_table=false" ng-show="edit_table">Close</a>
    </div>
    <div>
      <a href="" ng-click="fillTable(2,1)">Fill table</a>
    </div>
  </div>
  <div class="capability_form" ng-show="showcapability">
    <form>
      <h3>{{capability.name}}<h3>
    </form>
  </div>
</body>
</html>
